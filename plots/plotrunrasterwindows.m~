% plotrunrasterwindows
%       plots the output generated by runrasterwindows.  This is the same
%       section that is at the end of runrasterswindows.

%% for each epoch get all raster rows
for an = 1:size(f,2) % test with only one animal
    for ee = 1:size(f(an).epochs{1},1)
        subplot(2,1,1)
        cla;

        animal = animaldef(f(an).animal{1}, 'outputstruct',1);
        tet = f(an).data{1}{ee};
        tlist = [f(an).epochs{1}(ee,:) tet]; % tetrode index [day epoch tetrode-with-best-ripples]
        times = f(an).output{1}(ee).times{1};    % times are windows for freezing episodes
        if ~isempty(times)
            scoord = plotrasters(animal.dir, animal.pre, tlist, times, 'datatype', 'ripples', 'colorstr', 'c');
            frzcoord = plotrasterstate(animal.dir, animal.pre, tlist, times, 'datatype', 'estpos', 'colorstr', 'r');
        
            title(['animal ', animal.name, '  ', num2str(tlist)]);
        
        %++++++++++++++++++++++++++++++++
        % plot histogram of rasteroutput
        subplot(2,1,2);
        cla;
        
        
        
        % freeze state histogram
        rate = .01; % sampling rate in seconds
        buf = 1*rate; %function of rate
        winstart = 0 - buf;
        winend = 40 + buf;
        
        histtimes = [];
        histstate = [];
        
        warning('off');
        for ii = 1:size(frzcoord,1)
            [histtimes(:,ii), histstate(:,ii)] = event2state([frzcoord(ii,1); winend], [winstart; frzcoord(ii,2)], rate);
        end
        warning('on');
        
        %remove egde effects
        trim = 2;
        histtimes = histtimes(1+trim:end-trim,:);
        histstate = histstate(1+trim:end-trim,:);
        
        histin= histtimes .* histstate;
        histout = histc(histin, 0:1:40); % ?start index at rate?
        histom = mean(histout(2:end,:), 2);
        % still need to trim 0 hist bin and center on 20 seconds
        bar(1:1:size(histom,1),histom,1, 'EdgeColor', 'none', 'FaceColor', 'r'); alpha(.2);
        xlim([winstart winend]);
        
        keyboard;
        end   
    end
end